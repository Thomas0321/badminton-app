{% extends "base.html" %}

{% block title %}é¦–é  - ç¾½çƒæªåœ˜{% endblock %}

{% block content %}
<div class="hero-section bg-primary text-white rounded p-5 mb-5">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="display-4 mb-3">
                <i class="fas fa-shuttlecock-cock me-3"></i>ç¾½çƒæªåœ˜å¹³å°
            </h1>
            <p class="lead mb-4">æ‰¾åˆ°æœ€é©åˆçš„çƒå‹ï¼Œäº«å—ç¾½çƒçš„æ¨‚è¶£ï¼</p>
            <div class="d-flex gap-3">
                <button class="btn btn-light btn-lg" onclick="showTeams()">
                    <i class="fas fa-search me-2"></i>ğŸ“¥ åŠ å…¥éšŠä¼
                </button>
                <a href="{{ url_for('create_team') }}" class="btn btn-outline-light btn-lg">
                    <i class="fas fa-plus me-2"></i>â• å»ºç«‹éšŠä¼
                </a>
            </div>
        </div>
        <div class="col-md-4 text-center">
            <i class="fas fa-users fa-5x opacity-75"></i>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-4" id="filterSection" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>ç¯©é¸æ¢ä»¶</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="filterCity" class="form-label">ç¸£å¸‚</label>
                <select class="form-select" id="filterCity">
                    <option value="">å…¨éƒ¨</option>
                    <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
                    <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                    <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                    <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
                    <option value="å°å—å¸‚">å°å—å¸‚</option>
                    <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="filterVenue" class="form-label">çƒå ´åœ°é»</label>
                <input type="text" class="form-control" id="filterVenue" placeholder="è¼¸å…¥çƒå ´åç¨±">
            </div>
            <div class="col-md-3 mb-3">
                <label for="filterSkill" class="form-label">æŠ€è¡“æ°´å¹³</label>
                <select class="form-select" id="filterSkill">
                    <option value="">å…¨éƒ¨</option>
                    <option value="åˆå­¸">åˆå­¸</option>
                    <option value="åˆç´š">åˆç´š</option>
                    <option value="ä¸­ç´š">ä¸­ç´š</option>
                    <option value="ä¸­é«˜ç´š">ä¸­é«˜ç´š</option>
                    <option value="é«˜ç´š">é«˜ç´š</option>
                    <option value="ç«¶æŠ€">ç«¶æŠ€</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="filterTime" class="form-label">æ™‚æ®µ</label>
                <select class="form-select" id="filterTime">
                    <option value="">å…¨éƒ¨</option>
                    <option value="å¹³æ—¥ä¸Šåˆ">å¹³æ—¥ä¸Šåˆ</option>
                    <option value="å¹³æ—¥ä¸‹åˆ">å¹³æ—¥ä¸‹åˆ</option>
                    <option value="å¹³æ—¥æ™šé–“">å¹³æ—¥æ™šé–“</option>
                    <option value="å‡æ—¥ä¸Šåˆ">å‡æ—¥ä¸Šåˆ</option>
                    <option value="å‡æ—¥ä¸‹åˆ">å‡æ—¥ä¸‹åˆ</option>
                    <option value="å‡æ—¥æ™šé–“">å‡æ—¥æ™šé–“</option>
                </select>
            </div>
        </div>
        <div class="text-center">
            <button class="btn btn-primary" onclick="filterTeams()">
                <i class="fas fa-search me-2"></i>æœå°‹
            </button>
            <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                <i class="fas fa-times me-2"></i>æ¸…é™¤
            </button>
        </div>
    </div>
</div>

<!-- Teams List -->
<div id="teamsContainer" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-list me-2"></i>å¯åŠ å…¥çš„éšŠä¼</h3>
        <button class="btn btn-outline-primary" onclick="refreshTeams()">
            <i class="fas fa-sync-alt me-2"></i>é‡æ–°æ•´ç†
        </button>
    </div>
    <div id="teamsList" class="row">
        <!-- Teams will be loaded here -->
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
    </div>
    <p class="mt-2">è¼‰å…¥éšŠä¼è³‡è¨Šä¸­...</p>
</div>

<!-- Team Detail Modal -->
<div class="modal fade" id="teamModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="teamModalBody">
                <!-- Team details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                <button type="button" class="btn btn-primary" id="joinTeamBtn" onclick="joinTeam()">æˆ‘è¦åŠ å…¥</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTeamId = null;
let allTeams = [];

function showTeams() {
    document.getElementById('filterSection').style.display = 'block';
    document.getElementById('teamsContainer').style.display = 'block';
    loadTeams();
}

async function loadTeams() {
    document.getElementById('loadingSpinner').style.display = 'block';
    
    try {
        const response = await fetch('/teams');
        allTeams = await response.json();
        displayTeams(allTeams);
    } catch (error) {
        console.error('è¼‰å…¥éšŠä¼å¤±æ•—:', error);
        alert('è¼‰å…¥éšŠä¼å¤±æ•—ï¼Œè«‹é‡è©¦');
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

function displayTeams(teams) {
    const container = document.getElementById('teamsList');
    
    if (teams.length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„éšŠä¼</div></div>';
        return;
    }
    
    container.innerHTML = teams.map(team => `
        <div class="col-md-6 mb-4">
            <div class="card team-card h-100" onclick="showTeamDetail(${team.id})">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">${team.name}</h5>
                        <span class="badge bg-${team.current_members >= team.max_participants ? 'danger' : 'success'}">
                            ${team.current_members}/${team.max_participants}äºº
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>ä¸»è¾¦è€…ï¼š${team.organizer}
                        </small>
                    </div>
                    
                    <div class="mb-2">
                        <i class="fas fa-map-marker-alt me-1 text-primary"></i>
                        <strong>${team.location_city}</strong> - ${team.location_venue}
                    </div>
                    
                    <div class="mb-2">
                        <i class="fas fa-clock me-1 text-primary"></i>
                        ${formatDateTime(team.start_time)} - ${formatTime(team.end_time)}
                    </div>
                    
                    <div class="mb-2">
                        <span class="badge bg-info">${team.activity_type}</span>
                        ${team.waitlist_count > 0 ? `<span class="badge bg-warning ms-1">å€™è£œ ${team.waitlist_count}äºº</span>` : ''}
                    </div>
                    
                    ${team.description ? `<p class="card-text text-muted small">${team.description.substring(0, 100)}${team.description.length > 100 ? '...' : ''}</p>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function formatDateTime(dateTimeStr) {
    const date = new Date(dateTimeStr);
    return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
}

function formatTime(dateTimeStr) {
    const date = new Date(dateTimeStr);
    return date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
}

function showTeamDetail(teamId) {
    currentTeamId = teamId;
    const team = allTeams.find(t => t.id === teamId);
    
    if (!team) return;
    
    document.getElementById('teamModalTitle').textContent = team.name;
    
    const isFull = team.current_members >= team.max_participants;
    const joinBtn = document.getElementById('joinTeamBtn');
    
    if (isFull) {
        joinBtn.textContent = 'å€™è£œç™»è¨˜';
        joinBtn.className = 'btn btn-warning';
    } else {
        joinBtn.textContent = 'æˆ‘è¦åŠ å…¥';
        joinBtn.className = 'btn btn-primary';
    }
    
    document.getElementById('teamModalBody').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-user me-2"></i>ä¸»è¾¦è€…è³‡è¨Š</h6>
                <p>${team.organizer}</p>
                
                <h6><i class="fas fa-map-marker-alt me-2"></i>æ´»å‹•åœ°é»</h6>
                <p><strong>${team.location_city}</strong><br>
                ${team.location_venue}<br>
                <small class="text-muted">${team.location_address}</small></p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-clock me-2"></i>æ´»å‹•æ™‚é–“</h6>
                <p>${formatDateTime(team.start_time)}<br>
                è‡³ ${formatTime(team.end_time)}</p>
                
                <h6><i class="fas fa-users me-2"></i>åƒèˆ‡ç‹€æ³</h6>
                <p>å·²å ±åï¼š${team.current_members}/${team.max_participants}äºº<br>
                ${team.waitlist_count > 0 ? `å€™è£œï¼š${team.waitlist_count}äºº<br>` : ''}
                æ´»å‹•é¡å‹ï¼š<span class="badge bg-info">${team.activity_type}</span></p>
            </div>
        </div>
        
        ${team.description ? `
        <div class="mt-3">
            <h6><i class="fas fa-info-circle me-2"></i>æ´»å‹•èªªæ˜</h6>
            <p>${team.description}</p>
        </div>
        ` : ''}
        
        <div class="mt-3">
            <h6><i class="fas fa-comments me-2"></i>è¨è«–å€</h6>
            <div id="teamMessages" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                <div class="text-center text-muted">è¼‰å…¥ç•™è¨€ä¸­...</div>
            </div>
            <div class="mt-2">
                <div class="input-group">
                    <input type="text" class="form-control" id="newMessage" placeholder="è¼¸å…¥ç•™è¨€...">
                    <button class="btn btn-outline-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    loadTeamMessages(teamId);
    
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

async function loadTeamMessages(teamId) {
    try {
        const response = await fetch(`/team/${teamId}/messages`);
        const messages = await response.json();
        
        const container = document.getElementById('teamMessages');
        
        if (messages.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">é‚„æ²’æœ‰ç•™è¨€</div>';
            return;
        }
        
        container.innerHTML = messages.map(msg => `
            <div class="mb-2">
                <strong>${msg.user_nickname}</strong>
                <small class="text-muted">${msg.created_at}</small>
                <div>${msg.message}</div>
            </div>
        `).join('');
        
        container.scrollTop = container.scrollHeight;
    } catch (error) {
        console.error('è¼‰å…¥ç•™è¨€å¤±æ•—:', error);
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('newMessage');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    try {
        const response = await fetch(`/team/${currentTeamId}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageInput.value = '';
            loadTeamMessages(currentTeamId);
        } else {
            alert('ç™¼é€ç•™è¨€å¤±æ•—');
        }
    } catch (error) {
        alert('ç™¼é€ç•™è¨€å¤±æ•—');
    }
}

async function joinTeam() {
    if (!currentTeamId) return;
    
    try {
        const response = await fetch(`/join_team/${currentTeamId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`${result.status}ï¼`);
            const modal = bootstrap.Modal.getInstance(document.getElementById('teamModal'));
            modal.hide();
            refreshTeams();
        } else {
            alert(result.error || 'åŠ å…¥å¤±æ•—');
        }
    } catch (error) {
        alert('åŠ å…¥å¤±æ•—ï¼Œè«‹é‡è©¦');
    }
}

function filterTeams() {
    const city = document.getElementById('filterCity').value;
    const venue = document.getElementById('filterVenue').value.toLowerCase();
    const skill = document.getElementById('filterSkill').value;
    
    const filtered = allTeams.filter(team => {
        return (!city || team.location_city === city) &&
               (!venue || team.location_venue.toLowerCase().includes(venue)) &&
               (!skill || team.activity_type.includes(skill));
    });
    
    displayTeams(filtered);
}

function clearFilters() {
    document.getElementById('filterCity').value = '';
    document.getElementById('filterVenue').value = '';
    document.getElementById('filterSkill').value = '';
    document.getElementById('filterTime').value = '';
    displayTeams(allTeams);
}

function refreshTeams() {
    loadTeams();
}

// Add some CSS for better UX
const style = document.createElement('style');
style.textContent = `
    .team-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .team-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .hero-section {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
